# 多事业部日报和月报数据脚本 - 分销数据功能修改总结

## 修改概述

根据用户需求，为多事业部日报数据.py和多事业部月报数据.py添加了分销数据统计功能。

## 主要修改内容

### 1. 新增函数

#### 分销数据获取函数
- `get_fenxiao_data()`: 从HT_fenxiao表获取分销数据
- `identify_tianmao_fenxiao()`: 从原有数据中识别天猫分销数据（仓库字段包含"菜鸟仓自流转"）
- `categorize_product()`: 从产品名称中识别品类

#### 字段映射
- 分销商店铺名称 → 店铺名称
- 订单状态 → ERP数据的订单状态  
- 用户实际支付金额 → 销售金额
- 采购单支付时间 → 统计时间
- 产品名称 → 型号名字

### 2. 数据处理逻辑

#### 京东分销数据
- 从HT_fenxiao表获取数据
- 按店铺、品类、型号分组统计
- 先汇总到整体金额

#### 天猫分销数据
- 从原有数据库数据中识别
- 仓库字段匹配"菜鸟仓自流转"则标注分销
- 不重复计算，之前已经计算在内

### 3. 报表显示格式

#### 微信端修改
- 整体数据中增加"其中分销金额"行
- 品类明细中增加"其中分销金额"行
- 格式示例：
```
📊 整体数据
总销售额: ¥16,757,450（对比:¥13,728,239，环比:📈 22.1%）
总销量: 12,893件（对比:9,929，环比:📈 29.9%）
平均单价: ¥1,299（对比:¥1,382，环比:📉 -6.0%）
其中分销金额： ¥16,757,450（对比:¥13,728,239，环比:📈 22.1%）

📋 品类明细
• 家用空调: ¥11,722,881 (📈 39.4%)，9,392件 | 单价: ¥1,248
其中分销金额 ¥11,722,881 (📈 39.4%)，9,392件 | 单价: ¥1,248
```

#### Web端修改
- 整体数据中增加"其中分销销售"行
- 品类明细中增加"其中分销销售"行
- 店铺数据中增加"其中分销销售"行
- 格式示例：
```
📊 整体数据
总销售额: ¥1,520,299（对比:¥785,968，环比:📈 93.4%）
总销量: 603件（对比:338，环比:📈 78.4%）
平均单价: ¥2,521（对比:¥2,325，环比:📈 8.4%）
其中分销销售:

📋 品类明细
• 洗碗机: ¥1,112,208 (📈 115.8%)，375件 | 单价: ¥2,965
其中分销销售
• 厨电: ¥408,090 (📈 50.8%)，228件 | 单价: ¥1,789
其中分销销售
```

### 4. 单品数据统计

- 分销型号纳入统计和排序
- 在单品明细中显示分销数据

## 技术实现要点

### 1. 数据源集成
- 京东分销：HT_fenxiao表
- 天猫分销：原有数据中识别
- 自动品类识别：基于产品名称关键词匹配

### 2. 数据处理流程
1. 获取ERP主数据
2. 获取分销数据
3. 识别天猫分销数据
4. 合并所有数据
5. 按分组统计分销数据
6. 生成报表

### 3. 显示逻辑
- 有分销数据的自动展示
- 没有分销数据的自动忽略
- 保持原有格式不变

## 修改文件列表

1. **多事业部日报数据.py**
   - 添加分销数据获取函数
   - 修改数据预处理逻辑
   - 修改报表生成函数
   - 修改显示格式

2. **多事业部月报数据.py**
   - 添加分销数据获取函数
   - 修改数据预处理逻辑
   - 修改报表生成函数
   - 修改显示格式

## 注意事项

1. 确保HT_fenxiao表存在且有正确的字段
2. 确保原有数据中有仓库字段用于识别天猫分销
3. 分销数据会自动合并到主数据中，不影响原有统计逻辑
4. 所有报表都会自动检测并显示分销数据

## 测试建议

1. 测试分销数据获取是否正常
2. 测试天猫分销数据识别是否准确
3. 测试报表显示格式是否符合要求
4. 测试微信和Web端显示是否一致