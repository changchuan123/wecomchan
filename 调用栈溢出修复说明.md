# 调用栈溢出修复说明

## 问题描述
JavaScript脚本在执行过程中出现"Maximum call stack size exceeded"错误，导致程序崩溃。

## 问题原因分析

### 1. 递归调用问题
- 数据库连接管理中的递归调用
- 错误处理函数中的无限递归
- 批量插入失败后的重试逻辑

### 2. 内存管理问题
- 大量数据处理时内存泄漏
- 临时表创建和清理不当
- 复杂JOIN操作导致内存占用过高

### 3. 批量处理问题
- 批量大小设置过大（1000条）
- 单条插入时没有限制数量
- 并发处理过多导致资源耗尽

## 修复方案

### 1. 优化批量处理
```javascript
// 降低批量大小
batchSize: 100, // 从1000降低到100

// 限制单条插入数量
const maxSingleInserts = 20; // 避免处理过多数据
```

### 2. 简化去重检查
```javascript
// 移除复杂的临时表操作
// 使用分批IN查询替代复杂的JOIN
const checkBatchSize = 100;
for (let i = 0; i < validData.length; i += checkBatchSize) {
    // 分批检查重复数据
}
```

### 3. 添加内存管理
```javascript
// 强制垃圾回收
if (global.gc) {
    global.gc();
    console.log('🧹 已执行垃圾回收');
}
```

### 4. 优化错误处理
```javascript
// 避免递归调用
// 使用更安全的循环替代递归
for (let i = 0; i < limitedBatch.length; i++) {
    // 安全的单条插入
}
```

### 5. Daysales表统一处理
```javascript
// 移除Daysales表的特殊处理逻辑
// 所有表使用统一的processTableFiles函数
await processTableFiles(folder.tableName, fileGroups, uploadResults);
```

## 运行方式

### Windows
```bash
run_optimized_import.bat
```

### Linux/Mac
```bash
chmod +x run_optimized_import.sh
./run_optimized_import.sh
```

### 手动运行
```bash
# 设置Node.js参数
export NODE_OPTIONS="--max-old-space-size=2048 --expose-gc"

# 运行脚本
node 数据库上传_影刀版.js
```

## 配置优化

### config.js 修改
```javascript
performance: {
    batchSize: 100,           // 降低批量大小
    maxConcurrentBatches: 2,  // 降低并发数
    parallelFileProcessing: 0  // 禁用并行处理
}
```

## 测试验证

运行测试脚本验证修复效果：
```bash
node test_fix_stack_overflow.js
```

## 预期效果

1. ✅ 消除"Maximum call stack size exceeded"错误
2. ✅ 提高内存使用效率
3. ✅ 保持数据处理功能正常
4. ✅ 减少系统资源占用

## 注意事项

1. 批量大小降低可能影响处理速度，但提高了稳定性
2. 建议在测试环境验证后再部署到生产环境
3. 监控内存使用情况，必要时调整Node.js内存参数
4. 定期检查错误日志，及时处理异常情况 