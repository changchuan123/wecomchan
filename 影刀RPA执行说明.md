# 影刀RPA销售分析系统执行说明（直接执行版本）

## 📋 系统概述

本系统使用**直接执行**的代码形式，无需函数定义和类调用，专为影刀RPA优化设计。可以读取ERP销售数据，按照组织架构自动分组分析，并发送报告给相应部门的所有人员。

## 🎯 核心功能

1. **预获取组织架构**：启动时一次性获取所有事业部人员信息并缓存
2. **自动读取ERP数据**：直接连接数据库获取实时销售数据
3. **智能数据分组**：
   - **4个业务分组**：空调事业部、冰冷事业部、洗护事业部、厨卫事业部
   - **3个渠道分组**：抖音项目、卡萨帝项目、拼多多渠道
4. **高效消息发送**：使用缓存的人员列表直接发送，避免重复API调用

## ✨ 新版本优化特点

- **预加载人员信息**：程序启动时一次性获取所有部门人员信息
- **缓存机制**：避免重复调用组织架构API，提高发送成功率
- **直接列表发送**：数据处理完成后直接发送给对应的人员列表
- **更高稳定性**：减少API调用次数，降低网络错误风险

## 🚀 影刀RPA执行步骤

### 1. 数据库连接配置

系统直接连接ERP数据库获取实时销售数据，无需准备本地文件。

**数据源**：ERP数据库（实时连接）
**执行环境**：Windows机器
**数据获取**：自动查询最新销售数据

数据库表需包含以下字段（至少一个）：
- `商品名称` 或 `产品名称` 或 `商品标题`
- `店铺名称` 或 `店铺`
- `渠道` 或 `平台`
- `销售额` 或 `成交金额`
- `销售量` 或 `成交数量`
- `日期`

### 2. 系统架构

**影刀RPA执行环境**：Windows机器
**数据源**：ERP数据库（非本地文件）
**EdgeOne服务**：远程服务器部署
**访问域名**：https://edge.haierht.cn

### 3. 执行销售分析

在影刀中执行以下Python命令：

```bash
python3 影刀执行脚本.py
```

**执行流程**：
1. **获取人员信息** - 一次性获取所有事业部人员列表
2. **读取数据文件** - 从固定目录读取ERP数据
3. **智能字段映射** - 自动识别Excel/CSV字段
4. **数据分类分析** - 按业务和渠道进行分组
5. **生成报告** - 为每个分组生成详细报告
6. **批量发送** - 使用缓存的人员列表发送报告

## 📊 数据分组规则

### 业务分组关键词
- **空调事业部**：空调、挂机、柜机、中央空调、多联机
- **冰冷事业部**：冰箱、冷柜、保鲜、冷藏、冷冻
- **洗护事业部**：洗衣机、烘干机、洗烘一体
- **厨卫事业部**：热水器、洗碗机、厨电、净水器、软水机

### 渠道分组关键词
- **抖音项目**：抖音、快手
- **卡萨帝项目**：卡萨帝
- **拼多多渠道**：拼多多

## 🏢 组织架构对应关系

| 分组名称 | 部门ID | 负责人 |
|---------|-------|--------|
| 空调事业部 | 69 | YangNing |
| 冰冷事业部 | 70 | WeiCunGang |
| 洗护事业部 | 71 | YingJieBianHua |
| 厨卫事业部 | 72, 78 | WuXiang |
| 抖音项目 | 28 | LuZhiHang |
| 卡萨帝项目 | 3 | Mao |
| 拼多多渠道 | 76 | Wen |

## 📊 执行流程监控

### 实时执行状态显示
```
🚀 影刀RPA - 进阶销售分析系统（直接执行版本）
==================================================
📂 数据文件: 销售数据.xlsx
✅ 成功读取数据：500 条记录
✅ 字段映射完成: 6 个字段
✅ 数据分类完成
   空调事业部: 150 条数据
   冰冷事业部: 120 条数据
   洗护事业部: 80 条数据
   厨卫事业部: 100 条数据
   抖音项目: 50 条数据
   卡萨帝项目: 30 条数据
   拼多多渠道: 45 条数据

📊 开始生成业务分组报告...

🔄 处理 空调事业部...
✅ 空调事业部 报告发送: 8/8 成功

🔄 处理 冰冷事业部...
✅ 冰冷事业部 报告发送: 6/6 成功

📈 开始生成渠道分组报告...

🔄 处理 抖音项目...
✅ 抖音项目 报告发送: 5/5 成功

🎉 系统执行完成！
📊 销售报告已按组织架构发送完毕
📝 详细日志请查看: sales_analysis.log
```

## 📱 报告格式

### 业务分组报告格式
```
📊 【空调事业部】销售数据报告
🗓️ 报告日期：2024-01-15

📈 整体销售数据：
• 总销售额：¥1,234,567.89
• 总销售量：1,234件
• 平均单价：¥1,001.23
• 数据条数：150条

🏆 TOP销售明细：
 1. 海尔1.5匹变频空调
    店铺：海尔官方旗舰店
    销售额：¥123,456.78
    数量：89件

 2. 海尔3匹柜式空调
    店铺：海尔空调专卖店
    销售额：¥98,765.43
    数量：67件
```

### 渠道分组报告格式
```
📈 【抖音项目】销售数据报告
🗓️ 报告日期：2024-01-15

📈 整体销售数据：
• 总销售额：¥1,234,567.89
• 总销售量：2,345件
• 平均单价：¥526.38
• 数据条数：50条

🏆 TOP销售明细：
 1. 海尔迷你洗衣机
    店铺：海尔抖音官方店
    销售额：¥123,456.78
    数量：345件

 2. 海尔变频冰箱
    店铺：海尔快手专营店
    销售额：¥98,765.43
    数量：123件
```

## ⚠️ 注意事项

1. **数据文件格式**：确保Excel文件可正常打开，CSV文件使用UTF-8编码
2. **网络连接**：确保能访问企业微信服务器 (212.64.57.87:5001)
3. **权限确认**：确保有发送企业微信消息的权限
4. **数据完整性**：检查ERP数据的字段名称和数据质量

## 🔧 故障排除

### 常见问题及解决方案

1. **文件读取失败**
   - 检查文件路径是否正确
   - 确认文件格式（.xlsx 或 .csv）
   - 验证文件是否损坏

2. **组织架构获取失败**
   - 检查网络连接
   - 确认服务器地址：http://212.64.57.87:5001
   - 验证token：wecomchan_token

3. **消息发送失败**
   - 确认用户ID正确
   - 检查消息长度（建议小于2KB）
   - 验证企业微信权限

## 📞 技术支持

如遇到问题，请检查执行日志中的错误信息，或联系技术支持团队。

## 🎉 执行成功标志

看到以下信息表示执行成功：
```
📊 发送统计: X/Y 成功
🎉 销售分析完成！
✅ 任务执行成功！
```

其中 X/Y 表示成功发送的消息数/总消息数。

## 🔧 执行模式

### 在线模式（服务器可用）
当企业微信服务器 `212.64.57.87:5001` 可正常连接时：
1. ✅ 自动获取各事业部人员信息
2. ✅ 生成销售分析报告
3. ✅ 发送企业微信消息给相关人员
4. ✅ 实时显示发送成功率

### 离线模式（服务器不可达）
当服务器连接失败时自动启用：
1. ⚠️ 跳过人员信息获取
2. ✅ 正常生成销售分析报告
3. 📁 将报告保存为本地文件
4. 💡 提供后续处理建议

## 📊 数据处理流程

### 1. 数据源
- **固定路径**: `E:\电商数据\虹图\ERP订单明细`
- **支持格式**: Excel (.xlsx, .xls) 和 CSV (.csv)
- **自动扫描**: 自动查找目录下的数据文件

### 2. 业务分组
脚本会根据商品信息自动分组：

**事业部分组**:
- 空调事业部: 格力、美的、海尔、奥克斯、TCL
- 冰冷事业部: 容声、美菱、星星、白雪  
- 洗护事业部: 小天鹅、海尔洗衣机、美的洗衣机
- 厨卫事业部: 方太、老板、华帝、万和

**渠道分组**:
- 抖音项目: 抖音、抖店、直播、快手
- 卡萨帝项目: 卡萨帝、小红书
- 拼多多渠道: 拼多多、PDD

### 3. 报告内容
每个分组的报告包含：
- 💰 销售概况（总额、订单数、客单价）
- 🏆 TOP5商品明细
- 📝 详细日志记录

## 🚀 影刀RPA使用方法

### 1. 环境准备
```python
# 确保已安装必要的库
import pandas as pd
import requests
import numpy as np
import logging
```

### 2. 脚本执行
在影刀RPA中：
1. 将 `影刀执行脚本.py` 复制到Python脚本组件中
2. 直接运行，无需任何参数
3. 脚本会自动处理所有逻辑

### 3. 执行监控
脚本运行时会显示：
```
🔍 检查企业微信服务器状态...
🔄 正在检测服务器连接...
✅ 服务器连接正常，开始获取人员信息...
```

或者（离线模式）：
```
⚠️  企业微信服务器暂时无法连接
🔄 启用离线模式 - 将生成分析报告但不发送消息
📋 离线模式已启用
```

## 📁 输出文件

### 在线模式
- `sales_analysis.log` - 详细执行日志
- 企业微信消息实时发送

### 离线模式
- `{事业部}_销售报告_{YYYYMMDD_HHMM}.txt` - 各事业部报告
- `{渠道}_销售报告_{YYYYMMDD_HHMM}.txt` - 各渠道报告
- `sales_analysis.log` - 详细执行日志

## 🔧 故障排除

### 服务器连接问题
当出现连接错误时：
1. 脚本自动切换到离线模式
2. 生成本地报告文件
3. 可稍后手动发送或等服务器恢复后重新运行

### 数据文件问题
- 确保路径 `E:\电商数据\虹图\ERP订单明细` 存在
- 确保有Excel或CSV格式的数据文件
- 检查文件权限，确保可读取

### 数据格式问题
脚本已处理常见的数据类型问题：
- 自动转换数值型商品名称为字符串
- 安全的字段映射和空值处理
- 兼容不同的列名格式

## 💡 最佳实践

### 1. 定时执行
建议在影刀RPA中设置定时任务：
- 每日上午9点执行（数据更新后）
- 或根据数据更新频率调整

### 2. 错误处理
- 脚本已内置重试机制
- 自动切换离线模式
- 详细的日志记录便于问题诊断

### 3. 报告管理
- 离线模式的报告文件按日期时间命名
- 建议定期清理旧的报告文件
- 可根据需要调整报告内容格式

## 🔄 版本特性

### 当前版本优势
1. **智能容错** - 服务器问题时自动降级为离线模式
2. **零配置** - 固定路径，无需参数调整
3. **高成功率** - 缓存机制减少API调用失败
4. **实时反馈** - 详细的执行状态提示
5. **影刀适配** - 完全去除函数定义，直接执行模式

### 技术改进
- 增加30秒超时时间
- 3次重试机制
- 智能服务器状态检测
- 离线报告文件生成
- 优化的错误处理和日志记录

这个版本确保了即使在服务器不可用的情况下，销售分析工作也能正常进行，提供了更好的业务连续性保障。