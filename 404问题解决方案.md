# EdgeOne 404 错误问题解决方案

## 问题现状

根据最新的验证测试结果（2025-07-30 10:29:28），当前状况如下：

### ✅ 正常工作的部分
- EdgeOne 根目录访问正常：`https://edge.haierht.cn/reports/` (200 OK)
- API 健康检查正常：`https://edge.haierht.cn/api/health` (200 OK)
- Flask 服务器完全正常：`http://212.64.57.87:5002/reports/overall_daily_2025-07-29_101349.html` (200 OK)

### ❌ 存在问题的部分
- 具体报告文件访问失败：`https://edge.haierht.cn/reports/overall_daily_2025-07-29_101349.html` (404 错误)
- EdgeOne 没有检测到代理头部，说明边缘函数未部署或未生效

## 根本原因分析

1. **EdgeOne Pages 限制**：EdgeOne Pages 是静态网站托管服务，只能提供静态文件，无法动态代理到 Flask 服务器
2. **文件不存在**：EdgeOne Pages 中没有实际的 HTML 报告文件，因为这些文件存在于 Flask 服务器上
3. **缺少代理机制**：需要使用 EdgeOne 边缘函数来实现代理功能

## 解决方案

### 方案一：部署 EdgeOne 边缘函数（推荐）

#### 步骤 1：登录 EdgeOne 控制台
访问：https://console.cloud.tencent.com/edgeone

#### 步骤 2：创建边缘函数
1. 进入站点管理 → 选择 `sales-report` 站点
2. 点击左侧菜单 **"边缘函数"**
3. 点击 **"新建函数"**
4. 配置基本信息：
   - 函数名称：`flask-proxy`
   - 描述：`代理请求到 Flask 服务器，解决 404 错误`
   - 运行时：`JavaScript`

#### 步骤 3：复制边缘函数代码
使用项目中的 `edge_function_proxy.js` 文件内容，或直接复制以下代码：

```javascript
// EdgeOne 边缘函数 - 代理到 Flask 服务器
const FLASK_SERVER = 'http://212.64.57.87:5002';

addEventListener('fetch', (event) => {
  event.respondWith(handleRequest(event));
});

async function handleRequest(event) {
  const { request } = event;
  const url = new URL(request.url);
  
  try {
    const proxyUrl = `${FLASK_SERVER}${url.pathname}${url.search}`;
    console.log(`代理请求: ${request.url} -> ${proxyUrl}`);
    
    const proxyRequest = new Request(proxyUrl, {
      method: request.method,
      headers: request.headers,
      body: request.body,
      redirect: 'follow'
    });
    
    const response = await fetch(proxyRequest, {
      eo: {
        timeoutSetting: {
          connectTimeout: 30000,
          readTimeout: 30000,
          writeTimeout: 30000
        }
      }
    });
    
    const modifiedResponse = new Response(response.body, {
      status: response.status,
      statusText: response.statusText,
      headers: response.headers
    });
    
    modifiedResponse.headers.set('Access-Control-Allow-Origin', '*');
    modifiedResponse.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    modifiedResponse.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    
    return modifiedResponse;
    
  } catch (error) {
    console.error('代理请求失败:', error);
    return new Response(
      JSON.stringify({
        error: '代理服务器错误',
        message: error.message,
        timestamp: new Date().toISOString()
      }),
      {
        status: 502,
        statusText: 'Bad Gateway',
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*'
        }
      }
    );
  }
}
```

#### 步骤 4：配置触发规则
- 触发条件：URL 路径
- 匹配模式：`/*` （匹配所有路径）
- HTTP 方法：全部

#### 步骤 5：保存并发布
1. 点击 **"保存"**
2. 点击 **"发布"**
3. 等待部署完成（通常需要 2-5 分钟）

#### 步骤 6：验证部署
运行验证脚本：
```bash
python3 verify_edge_function.py
```

### 方案二：直接使用 Flask 服务器（临时方案）

如果边缘函数部署有困难，可以临时直接使用 Flask 服务器：
- 访问：`http://212.64.57.87:5002/reports/overall_daily_2025-07-29_101349.html`
- 缺点：没有 CDN 加速，访问速度较慢

### 方案三：生成静态文件（长期方案）

修改报告生成逻辑，将动态报告保存为静态 HTML 文件：
1. 在报告生成时，同时生成静态 HTML 文件
2. 将静态文件部署到 EdgeOne Pages
3. 优点：访问速度快，无需边缘函数
4. 缺点：需要修改现有代码逻辑

## 预期效果

部署边缘函数后，预期结果：
- ✅ `https://edge.haierht.cn/reports/overall_daily_2025-07-29_101349.html` 返回 200 OK
- ✅ 响应头包含 `Access-Control-Allow-Origin: *`
- ✅ 内容与 Flask 服务器完全一致
- ✅ 全球 CDN 加速访问

## 监控和维护

### 定期检查
1. 每日运行 `verify_edge_function.py` 验证服务状态
2. 监控 EdgeOne 控制台的函数执行日志
3. 关注函数调用次数和费用

### 故障排除
1. **502 错误**：检查 Flask 服务器状态
2. **超时错误**：调整边缘函数超时设置
3. **404 错误**：检查触发规则配置

## 成本考虑

- EdgeOne 边缘函数按请求次数计费
- 预估每月请求量：约 10,000 次
- 预估月费用：< 10 元人民币

## 总结

**推荐立即执行方案一**，通过部署 EdgeOne 边缘函数彻底解决 404 错误问题。这是最优解决方案，既保持了 CDN 加速的优势，又解决了静态托管无法访问动态内容的问题。

**关键文件**：
- 边缘函数代码：`edge_function_proxy.js`
- 部署脚本：`deploy_edge_function.py`
- 验证脚本：`verify_edge_function.py`
- 配置指南：`EdgeOne_边缘函数配置指南.md`

**下一步行动**：
1. 立即登录 EdgeOne 控制台
2. 按照上述步骤部署边缘函数
3. 运行验证脚本确认部署成功
4. 通知相关人员问题已解决