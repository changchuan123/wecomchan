# 手动部署详细指令

## 🎯 快速部署（推荐）

如果你有SSH访问权限，直接运行自动化脚本：

```bash
# 在本地项目目录执行
./deploy.sh
```

## 📋 手动部署详细步骤

### 步骤1: 连接到远程服务器
```bash
# 使用SSH连接（替换为你的实际用户名）
ssh root@212.64.57.87
```

### 步骤2: 停止旧服务
```bash
# 查看当前运行的服务
ps aux | grep wecomchan
netstat -tlnp | grep 5001

# 停止旧服务
pkill -f wecomchan_server.py
pkill -f wecomchan_server_updated.py

# 确认服务已停止
ps aux | grep wecomchan
```

### 步骤3: 备份原有文件
```bash
# 创建备份目录
BACKUP_DIR=~/wecomchan_backup/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份现有Python文件
cp *.py $BACKUP_DIR/ 2>/dev/null || true
echo "备份完成: $BACKUP_DIR"
```

### 步骤4: 上传新文件
在本地终端执行（不是在SSH会话中）：
```bash
# 上传更新后的服务器文件
scp wecomchan_server_updated.py root@212.64.57.87:/root/
```

### 步骤5: 安装/检查依赖
回到SSH会话中：
```bash
# 检查依赖
python3 -c "import flask, requests"

# 如果缺少依赖，安装它们
pip3 install flask requests --user
# 或者如果有权限
pip3 install flask requests
```

### 步骤6: 启动新服务
```bash
# 后台启动服务
nohup python3 wecomchan_server_updated.py > wecomchan.log 2>&1 &

# 等待服务启动
sleep 5

# 检查服务状态
ps aux | grep wecomchan_server_updated.py
netstat -tlnp | grep 5001
```

### 步骤7: 验证服务
```bash
# 本地健康检查
curl http://localhost:5001/health

# 测试部门列表
curl "http://localhost:5001/departments?token=wecomchan_token"

# 查看日志
tail -f wecomchan.log
```

## 🔧 故障排除

### 如果服务启动失败：
```bash
# 查看详细日志
cat wecomchan.log

# 检查端口占用
netstat -tlnp | grep 5001
ss -tlnp | grep 5001

# 手动启动查看错误
python3 wecomchan_server_updated.py
```

### 如果依赖安装失败：
```bash
# 更新pip
python3 -m pip install --upgrade pip --user

# 使用清华源安装
pip3 install flask requests -i https://pypi.tuna.tsinghua.edu.cn/simple/ --user
```

### 如果外网无法访问：
1. 检查腾讯云安全组设置
2. 检查本地防火墙：
```bash
# CentOS/RHEL
firewall-cmd --list-all
firewall-cmd --add-port=5001/tcp --permanent
firewall-cmd --reload

# Ubuntu/Debian
ufw status
ufw allow 5001
```

## 📊 验证部署成功

在本地测试远程服务：
```bash
# 健康检查
curl http://212.64.57.87:5001/health

# 部门列表
curl "http://212.64.57.87:5001/departments?token=wecomchan_token"

# 运行完整测试
python3 server_test.py
```

## 🎉 部署完成后的服务地址

- **健康检查**: http://212.64.57.87:5001/health
- **发送消息**: http://212.64.57.87:5001/send
- **部门列表**: http://212.64.57.87:5001/departments?token=wecomchan_token
- **用户列表**: http://212.64.57.87:5001/users?token=wecomchan_token
- **完整组织架构**: http://212.64.57.87:5001/organization?token=wecomchan_token

## 📝 维护命令

```bash
# 查看服务状态
ssh root@212.64.57.87 'ps aux | grep wecomchan'

# 查看服务日志
ssh root@212.64.57.87 'tail -f wecomchan.log'

# 重启服务
ssh root@212.64.57.87 'pkill -f wecomchan_server_updated.py && nohup python3 wecomchan_server_updated.py > wecomchan.log 2>&1 &'
``` 