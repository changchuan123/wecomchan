<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>{title}</title>
    <style>
        body {{ font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif; background: #f8f9fa; color: #222; margin: 0; padding: 2em; max-width: 900px; margin-left:auto; margin-right:auto; text-align: left; font-size: 10.5pt; }}
        h1, h2, h3 {{ color: #0056b3; text-align: left; font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif; font-size: 14pt; font-weight: bold; }}
        .section {{ margin-bottom: 2em; text-align: left; }}
        .overview-box {{ background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; }}
        .chart-container {{ margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }}
        .filter-controls {{ display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }}
        .filter-controls label {{ display: flex; align-items: center; gap: 5px; }}
        .filter-controls select {{ padding: 5px; border: 1px solid #ddd; border-radius: 4px; }}
    </style>
</head>
<body>
    <h1>{title}</h1>
    
    <!-- 30æ—¥è¶‹åŠ¿å›¾ -->
    <div class="section">
        <h2>ğŸ“ˆ è¿‘30å¤©é”€å”®è¶‹åŠ¿å›¾</h2>
        <div class="chart-container">
            <div class="filter-controls">
                <label>å“ç±»ï¼š
                    <select id="selCategory" onchange="updateFilters('category');updateChart()">
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </label>
                <label>åº—é“ºï¼š
                    <select id="selShop" onchange="updateFilters('shop');updateChart()">
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </label>
                <label>å•å“ï¼š
                    <select id="selProduct" onchange="updateChart()">
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </label>
            </div>
            <canvas id="trendChart" width="800" height="300" style="max-width:100%;"></canvas>
            
            <div id="detailsContainer" style="margin-top: 15px;">
                <!-- ç‚¹å‡»æŸ±çŠ¶å›¾æ—¶æ˜¾ç¤ºè¯¦ç»†æ•°æ® -->
            </div>
        </div>
    </div>
    
    <!-- æ•´ä½“é”€å”®æ¦‚å†µ -->
    <div class="overview-box">
        <h2>ğŸ’° ã€æ•´ä½“é”€å”®æ¦‚å†µã€‘</h2>
        <div style="font-size: 12pt; line-height: 1.6;">
            {overview_content}
        </div>
    </div>
    
    <!-- å…¶ä»–å†…å®¹ -->
    {other_content}
    
    <footer style="margin-top:2em;color:#888;font-size:0.9em;">è‡ªåŠ¨ç”Ÿæˆ | Powered by EdgeOne Pages & ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</footer>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// è¶‹åŠ¿æ•°æ® - ä½¿ç”¨ç®€åŒ–çš„æ•°æ®ç»“æ„
const trendData = {trend_json};

// å…¨å±€å˜é‡
let chart;
let allShops = new Set();
let allCategories = new Set();
let allProducts = new Set();

// åˆå§‹åŒ–å›¾è¡¨
function initChart() {{
    const ctx = document.getElementById('trendChart').getContext('2d');
    chart = new Chart(ctx, {{
        type: 'bar',
        data: {{
            labels: [],
            datasets: []
        }},
        options: {{
            responsive: true,
            interaction: {{
                mode: 'index',
                intersect: false
            }},
            plugins: {{
                title: {{
                    display: true,
                    text: 'é”€å”®è¶‹åŠ¿'
                }},
                legend: {{
                    display: true
                }}
            }},
            scales: {{
                y: {{
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {{
                        display: true,
                        text: 'é”€å”®é‡‘é¢ (Â¥)'
                    }}
                }},
                y1: {{
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {{
                        display: true,
                        text: 'é”€å”®æ•°é‡ (ä»¶)'
                    }},
                    grid: {{
                        drawOnChartArea: false
                    }}
                }}
            }}
        }}
    }});
    
    // åˆå§‹åŒ–ç­›é€‰é€‰é¡¹
    initFilters();
}}

// åˆå§‹åŒ–ç­›é€‰å™¨
function initFilters() {{
    if (!trendData || trendData.length === 0) {{
        console.log('è¶‹åŠ¿æ•°æ®ä¸ºç©º');
        return;
    }}
    
    console.log('è¶‹åŠ¿æ•°æ®æ¡æ•°:', trendData.length);
    
    // æ”¶é›†æ‰€æœ‰å”¯ä¸€å€¼
    trendData.forEach(item => {{
        if (item.shop) allShops.add(item.shop);
        if (item.category) allCategories.add(item.category);
        if (item.product) allProducts.add(item.product);
    }});
    
    // å¡«å……é€‰é¡¹
    populateCategoryOptions();
    populateShopOptions();
    populateProductOptions();
}}

// å¡«å……å“ç±»é€‰é¡¹
function populateCategoryOptions(selectedShop = 'all') {{
    const categorySelect = document.getElementById('selCategory');
    const currentValue = categorySelect.value;
    
    // è®¡ç®—å“ç±»é”€å”®é¢
    const categoryStats = {{}};
    trendData.forEach(item => {{
        if (selectedShop === 'all' || item.shop === selectedShop) {{
            if (!categoryStats[item.category]) {{
                categoryStats[item.category] = 0;
            }}
            categoryStats[item.category] += item.amount || 0;
        }}
    }});
    
    // æŒ‰é”€å”®é¢æ’åº
    const sortedCategories = Object.keys(categoryStats).sort((a, b) => categoryStats[b] - categoryStats[a]);
    
    // é‡æ–°å¡«å……é€‰é¡¹
    categorySelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
    sortedCategories.forEach(category => {{
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
    }});
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (currentValue && sortedCategories.includes(currentValue)) {{
        categorySelect.value = currentValue;
    }}
}}

// å¡«å……åº—é“ºé€‰é¡¹
function populateShopOptions(selectedCategory = 'all') {{
    const shopSelect = document.getElementById('selShop');
    const currentValue = shopSelect.value;
    
    // è®¡ç®—åº—é“ºé”€å”®é¢
    const shopStats = {{}};
    trendData.forEach(item => {{
        if (selectedCategory === 'all' || item.category === selectedCategory) {{
            if (!shopStats[item.shop]) {{
                shopStats[item.shop] = 0;
            }}
            shopStats[item.shop] += item.amount || 0;
        }}
    }});
    
    // æŒ‰é”€å”®é¢æ’åº
    const sortedShops = Object.keys(shopStats).sort((a, b) => shopStats[b] - shopStats[a]);
    
    // é‡æ–°å¡«å……é€‰é¡¹
    shopSelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
    sortedShops.forEach(shop => {{
        const option = document.createElement('option');
        option.value = shop;
        option.textContent = shop;
        shopSelect.appendChild(option);
    }});
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (currentValue && sortedShops.includes(currentValue)) {{
        shopSelect.value = currentValue;
    }}
}}

// å¡«å……å•å“é€‰é¡¹
function populateProductOptions(selectedCategory = 'all', selectedShop = 'all') {{
    const productSelect = document.getElementById('selProduct');
    const currentValue = productSelect.value;
    
    // è®¡ç®—å•å“é”€é‡
    const productStats = {{}};
    trendData.forEach(item => {{
        if ((selectedCategory === 'all' || item.category === selectedCategory) &&
            (selectedShop === 'all' || item.shop === selectedShop)) {{
            if (!productStats[item.product]) {{
                productStats[item.product] = 0;
            }}
            productStats[item.product] += item.qty || 0;
        }}
    }});
    
    // æŒ‰é”€é‡æ’åº
    const sortedProducts = Object.keys(productStats).sort((a, b) => productStats[b] - productStats[a]);
    
    // é‡æ–°å¡«å……é€‰é¡¹
    productSelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
    sortedProducts.forEach(product => {{
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productSelect.appendChild(option);
    }});
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
    if (currentValue && sortedProducts.includes(currentValue)) {{
        productSelect.value = currentValue;
    }}
}}

// æ›´æ–°ç­›é€‰å™¨
function updateFilters(changedFilter) {{
    const selectedCategory = document.getElementById('selCategory').value;
    const selectedShop = document.getElementById('selShop').value;
    
    if (changedFilter === 'category') {{
        populateShopOptions(selectedCategory);
        populateProductOptions(selectedCategory, selectedShop);
    }} else if (changedFilter === 'shop') {{
        populateCategoryOptions(selectedShop);
        populateProductOptions(selectedCategory, selectedShop);
    }}
}}

// æ›´æ–°å›¾è¡¨
function updateChart() {{
    if (!trendData || trendData.length === 0) {{
        console.log('è¶‹åŠ¿æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°å›¾è¡¨');
        return;
    }}
    
    const selectedShop = document.getElementById('selShop').value;
    const selectedCategory = document.getElementById('selCategory').value;
    const selectedProduct = document.getElementById('selProduct').value;
    
    // è¿‡æ»¤æ•°æ®
    let filteredData = trendData.filter(item => {{
        return (selectedShop === 'all' || item.shop === selectedShop) &&
               (selectedCategory === 'all' || item.category === selectedCategory) &&
               (selectedProduct === 'all' || item.product === selectedProduct);
    }});
    
    console.log('è¿‡æ»¤åæ•°æ®æ¡æ•°:', filteredData.length);
    
    // æŒ‰æ—¥æœŸèšåˆæ•°æ®
    const aggregatedData = {{}};
    filteredData.forEach(item => {{
        const date = item.date;
        if (!aggregatedData[date]) {{
            aggregatedData[date] = {{ amount: 0, qty: 0 }};
        }}
        aggregatedData[date].amount += item.amount || 0;
        aggregatedData[date].qty += item.qty || 0;
    }});
    
    // æ’åºæ—¥æœŸ
    const sortedDates = Object.keys(aggregatedData).sort();
    
    // ç”Ÿæˆæ•°æ®
    const amounts = sortedDates.map(date => aggregatedData[date].amount);
    const quantities = sortedDates.map(date => aggregatedData[date].qty);
    
    // æ ¼å¼åŒ–æ—¥æœŸæ ‡ç­¾
    const labels = sortedDates.map(date => {{
        const d = new Date(date);
        return (d.getMonth() + 1) + '-' + d.getDate().toString().padStart(2, '0');
    }});
    
    // æ›´æ–°å›¾è¡¨
    if (chart) {{
        chart.data.labels = labels;
        chart.data.datasets = [
            {{
                label: 'é”€å”®é‡‘é¢',
                data: amounts,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                yAxisID: 'y',
                type: 'bar'
            }},
            {{
                label: 'é”€å”®æ•°é‡',
                data: quantities,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                fill: false,
                yAxisID: 'y1',
                type: 'line'
            }}
        ];
        chart.update();
    }}
}}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {{
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
    initChart();
    updateChart();
}});
    </script>
</body>
</html>