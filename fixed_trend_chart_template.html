<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>{title}</title>
    <style>
        body {{ font-family: 'Microsoft YaHei', '微软雅黑', Arial, sans-serif; background: #f8f9fa; color: #222; margin: 0; padding: 2em; max-width: 900px; margin-left:auto; margin-right:auto; text-align: left; font-size: 10.5pt; }}
        h1, h2, h3 {{ color: #0056b3; text-align: left; font-family: 'Microsoft YaHei', '微软雅黑', Arial, sans-serif; font-size: 14pt; font-weight: bold; }}
        .section {{ margin-bottom: 2em; text-align: left; }}
        .overview-box {{ background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; }}
        .chart-container {{ margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }}
        .filter-controls {{ display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }}
        .filter-controls label {{ display: flex; align-items: center; gap: 5px; }}
        .filter-controls select {{ padding: 5px; border: 1px solid #ddd; border-radius: 4px; }}
    </style>
</head>
<body>
    <h1>{title}</h1>
    
    <!-- 30日趋势图 -->
    <div class="section">
        <h2>📈 近30天销售趋势图</h2>
        <div class="chart-container">
            <div class="filter-controls">
                <label>品类：
                    <select id="selCategory" onchange="updateFilters('category');updateChart()">
                        <option value="all">全部</option>
                    </select>
                </label>
                <label>店铺：
                    <select id="selShop" onchange="updateFilters('shop');updateChart()">
                        <option value="all">全部</option>
                    </select>
                </label>
                <label>单品：
                    <select id="selProduct" onchange="updateChart()">
                        <option value="all">全部</option>
                    </select>
                </label>
            </div>
            <canvas id="trendChart" width="800" height="300" style="max-width:100%;"></canvas>
            
            <div id="detailsContainer" style="margin-top: 15px;">
                <!-- 点击柱状图时显示详细数据 -->
            </div>
        </div>
    </div>
    
    <!-- 整体销售概况 -->
    <div class="overview-box">
        <h2>💰 【整体销售概况】</h2>
        <div style="font-size: 12pt; line-height: 1.6;">
            {overview_content}
        </div>
    </div>
    
    <!-- 其他内容 -->
    {other_content}
    
    <footer style="margin-top:2em;color:#888;font-size:0.9em;">自动生成 | Powered by EdgeOne Pages & 企业微信机器人</footer>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// 趋势数据 - 使用简化的数据结构
const trendData = {trend_json};

// 全局变量
let chart;
let allShops = new Set();
let allCategories = new Set();
let allProducts = new Set();

// 初始化图表
function initChart() {{
    const ctx = document.getElementById('trendChart').getContext('2d');
    chart = new Chart(ctx, {{
        type: 'bar',
        data: {{
            labels: [],
            datasets: []
        }},
        options: {{
            responsive: true,
            interaction: {{
                mode: 'index',
                intersect: false
            }},
            plugins: {{
                title: {{
                    display: true,
                    text: '销售趋势'
                }},
                legend: {{
                    display: true
                }}
            }},
            scales: {{
                y: {{
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {{
                        display: true,
                        text: '销售金额 (¥)'
                    }}
                }},
                y1: {{
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {{
                        display: true,
                        text: '销售数量 (件)'
                    }},
                    grid: {{
                        drawOnChartArea: false
                    }}
                }}
            }}
        }}
    }});
    
    // 初始化筛选选项
    initFilters();
}}

// 初始化筛选器
function initFilters() {{
    if (!trendData || trendData.length === 0) {{
        console.log('趋势数据为空');
        return;
    }}
    
    console.log('趋势数据条数:', trendData.length);
    
    // 收集所有唯一值
    trendData.forEach(item => {{
        if (item.shop) allShops.add(item.shop);
        if (item.category) allCategories.add(item.category);
        if (item.product) allProducts.add(item.product);
    }});
    
    // 填充选项
    populateCategoryOptions();
    populateShopOptions();
    populateProductOptions();
}}

// 填充品类选项
function populateCategoryOptions(selectedShop = 'all') {{
    const categorySelect = document.getElementById('selCategory');
    const currentValue = categorySelect.value;
    
    // 计算品类销售额
    const categoryStats = {{}};
    trendData.forEach(item => {{
        if (selectedShop === 'all' || item.shop === selectedShop) {{
            if (!categoryStats[item.category]) {{
                categoryStats[item.category] = 0;
            }}
            categoryStats[item.category] += item.amount || 0;
        }}
    }});
    
    // 按销售额排序
    const sortedCategories = Object.keys(categoryStats).sort((a, b) => categoryStats[b] - categoryStats[a]);
    
    // 重新填充选项
    categorySelect.innerHTML = '<option value="all">全部</option>';
    sortedCategories.forEach(category => {{
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
    }});
    
    // 恢复之前的选择
    if (currentValue && sortedCategories.includes(currentValue)) {{
        categorySelect.value = currentValue;
    }}
}}

// 填充店铺选项
function populateShopOptions(selectedCategory = 'all') {{
    const shopSelect = document.getElementById('selShop');
    const currentValue = shopSelect.value;
    
    // 计算店铺销售额
    const shopStats = {{}};
    trendData.forEach(item => {{
        if (selectedCategory === 'all' || item.category === selectedCategory) {{
            if (!shopStats[item.shop]) {{
                shopStats[item.shop] = 0;
            }}
            shopStats[item.shop] += item.amount || 0;
        }}
    }});
    
    // 按销售额排序
    const sortedShops = Object.keys(shopStats).sort((a, b) => shopStats[b] - shopStats[a]);
    
    // 重新填充选项
    shopSelect.innerHTML = '<option value="all">全部</option>';
    sortedShops.forEach(shop => {{
        const option = document.createElement('option');
        option.value = shop;
        option.textContent = shop;
        shopSelect.appendChild(option);
    }});
    
    // 恢复之前的选择
    if (currentValue && sortedShops.includes(currentValue)) {{
        shopSelect.value = currentValue;
    }}
}}

// 填充单品选项
function populateProductOptions(selectedCategory = 'all', selectedShop = 'all') {{
    const productSelect = document.getElementById('selProduct');
    const currentValue = productSelect.value;
    
    // 计算单品销量
    const productStats = {{}};
    trendData.forEach(item => {{
        if ((selectedCategory === 'all' || item.category === selectedCategory) &&
            (selectedShop === 'all' || item.shop === selectedShop)) {{
            if (!productStats[item.product]) {{
                productStats[item.product] = 0;
            }}
            productStats[item.product] += item.qty || 0;
        }}
    }});
    
    // 按销量排序
    const sortedProducts = Object.keys(productStats).sort((a, b) => productStats[b] - productStats[a]);
    
    // 重新填充选项
    productSelect.innerHTML = '<option value="all">全部</option>';
    sortedProducts.forEach(product => {{
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productSelect.appendChild(option);
    }});
    
    // 恢复之前的选择
    if (currentValue && sortedProducts.includes(currentValue)) {{
        productSelect.value = currentValue;
    }}
}}

// 更新筛选器
function updateFilters(changedFilter) {{
    const selectedCategory = document.getElementById('selCategory').value;
    const selectedShop = document.getElementById('selShop').value;
    
    if (changedFilter === 'category') {{
        populateShopOptions(selectedCategory);
        populateProductOptions(selectedCategory, selectedShop);
    }} else if (changedFilter === 'shop') {{
        populateCategoryOptions(selectedShop);
        populateProductOptions(selectedCategory, selectedShop);
    }}
}}

// 更新图表
function updateChart() {{
    if (!trendData || trendData.length === 0) {{
        console.log('趋势数据为空，无法更新图表');
        return;
    }}
    
    const selectedShop = document.getElementById('selShop').value;
    const selectedCategory = document.getElementById('selCategory').value;
    const selectedProduct = document.getElementById('selProduct').value;
    
    // 过滤数据
    let filteredData = trendData.filter(item => {{
        return (selectedShop === 'all' || item.shop === selectedShop) &&
               (selectedCategory === 'all' || item.category === selectedCategory) &&
               (selectedProduct === 'all' || item.product === selectedProduct);
    }});
    
    console.log('过滤后数据条数:', filteredData.length);
    
    // 按日期聚合数据
    const aggregatedData = {{}};
    filteredData.forEach(item => {{
        const date = item.date;
        if (!aggregatedData[date]) {{
            aggregatedData[date] = {{ amount: 0, qty: 0 }};
        }}
        aggregatedData[date].amount += item.amount || 0;
        aggregatedData[date].qty += item.qty || 0;
    }});
    
    // 排序日期
    const sortedDates = Object.keys(aggregatedData).sort();
    
    // 生成数据
    const amounts = sortedDates.map(date => aggregatedData[date].amount);
    const quantities = sortedDates.map(date => aggregatedData[date].qty);
    
    // 格式化日期标签
    const labels = sortedDates.map(date => {{
        const d = new Date(date);
        return (d.getMonth() + 1) + '-' + d.getDate().toString().padStart(2, '0');
    }});
    
    // 更新图表
    if (chart) {{
        chart.data.labels = labels;
        chart.data.datasets = [
            {{
                label: '销售金额',
                data: amounts,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                yAxisID: 'y',
                type: 'bar'
            }},
            {{
                label: '销售数量',
                data: quantities,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                fill: false,
                yAxisID: 'y1',
                type: 'line'
            }}
        ];
        chart.update();
    }}
}}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {{
    console.log('页面加载完成，开始初始化图表');
    initChart();
    updateChart();
}});
    </script>
</body>
</html>