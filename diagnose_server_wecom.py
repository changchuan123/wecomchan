#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è¯Šæ–­æœåŠ¡å™¨ç«¯ä¼ä¸šå¾®ä¿¡é…ç½®é—®é¢˜
"""

import requests
import json

def diagnose_server_wecom():
    """è¯Šæ–­æœåŠ¡å™¨ç«¯ä¼ä¸šå¾®ä¿¡é…ç½®é—®é¢˜"""
    
    print("ğŸ” è¯Šæ–­æœåŠ¡å™¨ç«¯ä¼ä¸šå¾®ä¿¡é…ç½®é—®é¢˜...")
    print("="*60)
    
    # 1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    print("1ï¸âƒ£ æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...")
    try:
        response = requests.get("http://212.64.57.87:5001/status", timeout=10)
        status = response.json()
        print(f"âœ… æœåŠ¡å™¨çŠ¶æ€: {status.get('status')}")
        print(f"ğŸ“‹ é…ç½®ä¿¡æ¯: {json.dumps(status.get('config', {}), indent=2, ensure_ascii=False)}")
    except Exception as e:
        print(f"âŒ æ— æ³•è·å–æœåŠ¡å™¨çŠ¶æ€: {e}")
        return
    
    # 2. æµ‹è¯•ä¼ä¸šå¾®ä¿¡é…ç½®
    print("\n2ï¸âƒ£ æµ‹è¯•ä¼ä¸šå¾®ä¿¡é…ç½®...")
    test_msg = "ğŸ”§ ä¼ä¸šå¾®ä¿¡é…ç½®è¯Šæ–­æµ‹è¯•\n\nè¿™æ˜¯ä¸€æ¡è¯Šæ–­æ¶ˆæ¯ï¼Œç”¨äºæ£€æŸ¥ä¼ä¸šå¾®ä¿¡é…ç½®é—®é¢˜ã€‚"
    
    data = {
        "msg": test_msg,
        "token": "wecomchan_token",
        "to_user": "weicungang"
    }
    
    try:
        response = requests.post("http://212.64.57.87:5001/send", json=data, timeout=30)
        result = response.json()
        
        print(f"ğŸ“¤ æœåŠ¡å™¨å“åº”: {json.dumps(result, indent=2, ensure_ascii=False)}")
        
        if result.get('errcode') == 0:
            print("âœ… ä¼ä¸šå¾®ä¿¡é…ç½®æ­£å¸¸ï¼")
        else:
            print(f"âŒ ä¼ä¸šå¾®ä¿¡é…ç½®æœ‰é—®é¢˜: {result.get('errmsg')}")
            
            # åˆ†æé”™è¯¯ä¿¡æ¯
            errmsg = result.get('errmsg', '')
            if 'invalid corpid' in errmsg.lower():
                print("\nğŸ” é—®é¢˜åˆ†æ: invalid corpid é”™è¯¯")
                print("ğŸ’¡ å¯èƒ½çš„åŸå› :")
                print("   1. æœåŠ¡å™¨ç«¯çš„ä¼ä¸šå¾®ä¿¡å…¬å¸ID (corpid) å·²è¿‡æœŸæˆ–æ— æ•ˆ")
                print("   2. æœåŠ¡å™¨ç«¯ä½¿ç”¨äº†é”™è¯¯çš„ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®")
                print("   3. ä¼ä¸šå¾®ä¿¡åº”ç”¨æƒé™è®¾ç½®æœ‰é—®é¢˜")
                print("\nğŸ› ï¸ è§£å†³æ–¹æ¡ˆ:")
                print("   1. æ£€æŸ¥æœåŠ¡å™¨ç«¯çš„ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®")
                print("   2. æ›´æ–°æœåŠ¡å™¨ç«¯çš„ä¼ä¸šå¾®ä¿¡å…¬å¸IDå’ŒSecret")
                print("   3. ç¡®è®¤ä¼ä¸šå¾®ä¿¡åº”ç”¨æƒé™è®¾ç½®")
                print("   4. è”ç³»æœåŠ¡å™¨ç®¡ç†å‘˜æ›´æ–°é…ç½®")
                
            elif 'access_token' in errmsg.lower():
                print("\nğŸ” é—®é¢˜åˆ†æ: access_token è·å–å¤±è´¥")
                print("ğŸ’¡ å¯èƒ½çš„åŸå› :")
                print("   1. ä¼ä¸šå¾®ä¿¡åº”ç”¨Secretæ— æ•ˆ")
                print("   2. ä¼ä¸šå¾®ä¿¡åº”ç”¨æƒé™ä¸è¶³")
                print("   3. ç½‘ç»œè¿æ¥é—®é¢˜")
                
    except Exception as e:
        print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
    
    # 3. æä¾›è§£å†³æ–¹æ¡ˆ
    print("\n3ï¸âƒ£ è§£å†³æ–¹æ¡ˆå»ºè®®...")
    print("ğŸ“‹ ç”±äºæœåŠ¡å™¨ç«¯ä¼ä¸šå¾®ä¿¡é…ç½®æœ‰é—®é¢˜ï¼Œå»ºè®®:")
    print("   1. è”ç³»æœåŠ¡å™¨ç®¡ç†å‘˜ (212.64.57.87) æ£€æŸ¥ä¼ä¸šå¾®ä¿¡é…ç½®")
    print("   2. æ›´æ–°æœåŠ¡å™¨ç«¯çš„ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®")
    print("   3. ç¡®è®¤ä¼ä¸šå¾®ä¿¡åº”ç”¨çš„å…¬å¸IDã€Secretå’Œåº”ç”¨IDæ˜¯å¦æ­£ç¡®")
    print("   4. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡åº”ç”¨çš„æƒé™è®¾ç½®")
    print("\nğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ:")
    print("   1. å¯ä»¥æš‚æ—¶ç¦ç”¨ä¼ä¸šå¾®ä¿¡æ¨é€åŠŸèƒ½")
    print("   2. ä½¿ç”¨å…¶ä»–é€šçŸ¥æ–¹å¼ï¼ˆå¦‚é‚®ä»¶ã€çŸ­ä¿¡ç­‰ï¼‰")
    print("   3. ç­‰å¾…æœåŠ¡å™¨ç«¯é…ç½®ä¿®å¤åå†å¯ç”¨æ¨é€")

if __name__ == "__main__":
    print("ğŸš€ å¼€å§‹è¯Šæ–­æœåŠ¡å™¨ç«¯ä¼ä¸šå¾®ä¿¡é…ç½®é—®é¢˜...\n")
    diagnose_server_wecom()
    print("\nâœ… è¯Šæ–­å®Œæˆï¼") 